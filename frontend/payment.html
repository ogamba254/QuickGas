<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa Checkout | QuickGas</title>
    <style>
        :root {
            --mpesa-green: #4db848;
            --mpesa-dark: #3e9e3a;
            --bg-color: #f0f2f5;
            --text-main: #2d3436;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .payment-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .secure-tag {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #636e72;
            display: block;
            margin-bottom: 30px;
        }

        .amount-section { margin-bottom: 30px; }
        .amount-label { font-size: 14px; color: #636e72; margin-bottom: 5px; }
        .amount-value { font-size: 32px; font-weight: 800; color: var(--text-main); }

        .input-group { text-align: left; margin-bottom: 25px; }
        label { font-size: 13px; font-weight: 600; color: var(--text-main); display: block; margin-bottom: 8px; }

        input[type="tel"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .pay-btn {
            background-color: var(--mpesa-green);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .pay-btn:disabled { background-color: #b2bec3; cursor: not-allowed; }

        .status-msg { margin-top: 15px; font-size: 14px; color: #e67e22; font-weight: bold; display: none; }

        .loader {
            display: none;
            margin: 15px auto 0;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--mpesa-green);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="payment-card">
        <span class="secure-tag">Secure Checkout</span>
        <h1 style="color: #4db848; margin: 0;">M-Pesa</h1>
        
        <div class="amount-section">
            <div class="amount-label">Amount Due</div>
            <div class="amount-value">KES <span id="displayAmount">0.00</span></div>
        </div>

        <form id="paymentForm">
            <div class="input-group">
                <label for="phone">Enter M-Pesa Phone Number</label>
                <input type="tel" id="phone" placeholder="e.g. 0701087111" required>
            </div>

            <button type="submit" id="payBtn" class="pay-btn">COMPLETE ORDER & PAY</button>
            <div id="loader" class="loader"></div>
            <div id="statusMsg" class="status-msg">Waiting for payment... (60s)</div>
        </form>
    </div>

<script>
    const params = new URLSearchParams(window.location.search);
    const rawAmount = params.get('amount');
    const finalAmountValue = rawAmount ? parseFloat(rawAmount) : 0;
    
    document.getElementById('displayAmount').innerText = finalAmountValue > 0 
        ? finalAmountValue.toLocaleString() 
        : "0.00";

    function formatPhoneNumber(phone) {
        let clean = phone.replace(/\D/g, ''); 
        if (clean.startsWith('0')) return '254' + clean.substring(1);
        if (clean.startsWith('7') || clean.startsWith('1')) return '254' + clean;
        return clean;
    }

    document.getElementById('paymentForm').onsubmit = async function(e) {
        e.preventDefault();
        
        if (finalAmountValue <= 0) {
            alert("⚠️ Error: No valid amount detected. Please go back and select a product.");
            return;
        }

        const phoneInput = document.getElementById('phone').value;
        const formattedPhone = formatPhoneNumber(phoneInput);
        const btn = document.getElementById('payBtn');
        const loader = document.getElementById('loader');
        const statusMsg = document.getElementById('statusMsg');

        btn.disabled = true;
        btn.innerText = "Check your phone...";
        loader.style.display = "block";

        try {
            const response = await fetch('https://quickgas-1.onrender.com/stkpush', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    phone: formattedPhone, 
                    amount: Math.round(finalAmountValue)
                })
            });

            const data = await response.json();

            if (data.CheckoutRequestID) {
                statusMsg.style.display = "block";
                pollTransactionStatus(data.CheckoutRequestID, finalAmountValue);
            } else {
                alert("❌ M-Pesa Error: " + (data.CustomerMessage || "Failed to start transaction."));
                resetUI();
            }
        } catch (error) {
            alert("⚠️ Connection Failed. Check if your server is running.");
            resetUI();
        }

        function resetUI() {
            btn.disabled = false;
            btn.innerText = "COMPLETE ORDER & PAY";
            loader.style.display = "none";
        }
    };

    async function pollTransactionStatus(checkoutID, amountPaid) {
        const startTime = Date.now();
        const duration = 60000; 
        const statusMsg = document.getElementById('statusMsg');

        const interval = setInterval(async () => {
            const timeLeft = Math.round((duration - (Date.now() - startTime)) / 1000);
            statusMsg.innerText = `Waiting for payment confirmation... (${timeLeft}s)`;

            if (timeLeft <= 0) {
                clearInterval(interval);
                alert("⏰ Timeout: We didn't receive your payment. Taking you back home.");
                window.location.href = "index.html"; 
                return;
            }

            try {
                const check = await fetch(`https://quickgas-1.onrender.com/query-status/${checkoutID}`);
                const result = await check.json();

                if (result.status === "PAID") {
                    clearInterval(interval);
                    window.location.href = `receipt.html?id=${checkoutID}&amount=${amountPaid}`;
                } else if (result.status === "FAILED") {
                    // --- REDIRECT TO HOME ON CANCEL/FAILURE ---
                    clearInterval(interval);
                    alert("❌ Transaction was cancelled or failed. Redirecting to home.");
                    window.location.href = "index.html"; 
                }
            } catch (e) {
                console.log("Waiting for M-Pesa callback...");
            }
        }, 3000);
    }
</script>
</body>
</html>